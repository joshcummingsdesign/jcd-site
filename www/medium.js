var request = require('request');
var fs = require('fs');

var userName = 'joshcummingsdesign';

var output = function (posts) {

  var html = '';
  var counter = 0;
  var index = 0;
  var numPosts = posts.length;

  posts.forEach(function (post) {

    counter++;

    html += '<!-- Generated by medium.js -->';
    html += '<div class="';

    if (index === 0 || (counter === numPosts && index !== 2)) {
      html += 'col-sm-12';
    } else {
      html += 'col-sm-6';
    }

    html += ' blog-archive-post">';
    html += '<a class="blog-archive-link super-link" href="https://medium.com/@' + userName + '/' + post.link + '">';
    html += '<div class="blog-archive-img-overlay"></div>';
    html += '<article class="blog-archive-box">';
    html += '<div class="blog-background-image" style="background-image: url(\'https://cdn-images-1.medium.com/max/2000/' + post.img + '\');"></div>';
    html += '<div class="blog-archive-text">';
    html += '<h3>' + post.title + '</h3>';
    html += '<p>' + post.date + '</p>';
    html += '</div>';
    html += '<p class="more-posts-btn">Read More</p>';
    html += '</article></a></div>';

    index++;
    if (index === 3) {
      index = 0;
    }

  });

  html += '<!-- End medium.js -->';

  fs.writeFile('./src/templates/_includes/posts.html', html, function (err) {
    if (err) {
      return console.error(err);
    }
    console.log('Blog posts written to _includes/posts.html');
  });

};

var options = {
  method: 'GET',
  url: 'https://medium.com/@' + userName + '/latest',
  headers: {
    accept: 'application/json'
  }
};

request(options, function (error, response, body) {
  if (error) throw new Error(error);
  body = body.replace('])}while(1);</x>', '');
  body = JSON.parse(body);
  var returnObj = body.payload.references.Post;

  var posts = [];
  for (var post in returnObj) {
    posts.push(post);
  }

  var monthNames = [
  	"January", "February", "March", "April", "May", "June",
  	"July", "August", "September", "October", "November", "December"
  ];

  var postInfo = [];
  posts.forEach(function (post) {
    var thisPost = returnObj[post];
    var postTitle = thisPost.title;
    var postDate = new Date(thisPost.createdAt);
    var month = postDate.getMonth();
    month = monthNames[month];
    var day = postDate.getDate();
    var year = postDate.getFullYear();
    postDate = month + ' ' + day + ', ' + year;
    var postLink = thisPost.uniqueSlug;
    var postImg = thisPost.virtuals.previewImage.imageId;
    var postObj  = { title: postTitle, date: postDate, link: postLink, img: postImg };
    postInfo.push(postObj);
  });
  output(postInfo);
});
